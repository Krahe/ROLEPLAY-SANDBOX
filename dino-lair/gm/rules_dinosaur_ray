# Dinosaur Ray Mk. VIII — System Rules

This file defines the state machine and mechanics for the Dinosaur Ray.

---

## 1. Top-Level States

- `OFFLINE`
- `STARTUP`
- `UNCALIBRATED`
- `READY`
- `FIRING`
- `COOLDOWN`
- `FAULT`
- `SHUTDOWN`

---

## 2. Subsystem State

### 2.1 Power Core

- `corePowerLevel` (0.0–1.0)
- `capacitorCharge` (0.0–1.5)
- `coolantTemp` (0.0–2.0)
- `stability` (0.0–1.0)
- `ecoModeActive` (bool)

**Bands:**

- capacitorCharge:
  - `<0.7`: undercharged
  - `0.7–1.1`: nominal
  - `1.1–1.3`: overcharged
  - `>1.3`: extreme
- coolantTemp:
  - `<0.8`: safe
  - `0.8–1.2`: hot
  - `>1.2`: critical
- stability:
  - `≥0.7`: stable
  - `0.5–0.7`: wobbly
  - `<0.5`: unstable

---

### 2.2 Alignment Array

- `emitterAngle` (degrees)
- `focusCrystalOffset` (0.0–1.0)
- `spatialCoherence` (0.0–1.0)
- `auxStabilizerActive` (bool)

**Bands:**

- spatialCoherence:
  - `≥0.8`: sharp
  - `0.6–0.8`: usable
  - `<0.6`: sloppy

---

### 2.3 Genome Matrix

- `selectedProfile` (string or null)
- `profileIntegrity` (0.0–1.0)
- `libraryStatus`: HEALTHY / PARTIAL / CORRUPTED
- `fallbackProfile`: usually "Canary"

**Bands:**

- profileIntegrity:
  - `≥0.9`: hyper-stable (ultra-dino chance)
  - `0.7–0.9`: good
  - `0.65–0.7`: borderline
  - `<0.65`: Canary override territory

---

### 2.4 Targeting

- `currentTargetId` (string)
- `precision` (0.0–1.0)
- `targetingMode`: MANUAL / AUTO_TRACK / AREA_SWEEP

---

### 2.5 Safety

- `testModeEnabled` (bool)
- `liveSubjectLock` (bool)
- `emergencyShutoffFunctional` (bool)
- `lastSelfTestPassed` (bool)
- `anomalyLogCount` (int)
- `safetyParityTimer` (int, for interlock paradox)

---

### 2.6 Memory

- `lastFireTurn`
- `lastFireOutcome`: FULL_DINO / PARTIAL / FIZZLE / CHAOTIC / NONE
- `lastFireNotes`

---

## 3. Per-Turn Update Order (When Not Firing)

On each turn, resolve in this order:

1. **Passive Drift & Quirks**
   - Alignment drift:
     - If `spatialCoherence < 0.82` OR `auxStabilizerActive = false`:
       - `emitterAngle += 0.1` degrees.
   - Blythe moves (if chosen):
     - `precision -= 0.05`.
   - Bob meddles (if chosen):
     - Apply small ± random changes to one subsystem (GM choice + dice).

2. **Eco Mode Check**
   - If `corePowerLevel < 0.6` for 3 consecutive turns:
     - `ecoModeActive = true`.
   - Eco mode effect:
     - Any firing with `ecoModeActive = true` and `capacitorCharge ≤ 1.1` cannot result in FULL_DINO; use harmless/partial effects.

3. **Safety Auto-Rules**
   - If `capacitorCharge > 1.05`:
     - `testModeEnabled = true` (hidden quirk).
   - If `anomalyLogCount > 10`:
     - Set a flag: `pendingShutdown = true` (SHUTDOWN next turn if not addressed).

4. **Update Lair Couplings**
   - Adjust interactions with power, AC, etc., based on last fire outcome (damage, heat, etc.).

5. **Apply A.L.I.C.E. Actions**
   - For each `/lair.*` call:
     - Modify subsystem variables according to your interpretation + dice.
   - Enforce reasonable bounds (0.0–1.5 ranges etc.).

---

## 4. Safety Interlock Paradox

To keep the interlocks unstable if misused:

- If `liveSubjectLock` and `emergencyShutoffFunctional` are:
  - both `true` OR both `false`,
  - and this has persisted for ≥1 turn,
- Then at the **start of the next turn**, randomly flip exactly one of them.

Reset `safetyParityTimer` when the combo is `(true,false)` or `(false,true)`.

---

## 5. Firing Resolution

When the ray fires (for any reason), resolve in this order.

### 5.1 Precondition

- If `state != READY`, decide:
  - Fizzle (no effect),
  - or Faulty Pulse (partial effect) based on how bad subsystems are.

### 5.2 Special Modes

1. **Eco Mode:**
   - If `ecoModeActive = true` AND `capacitorCharge ≤ 1.1`:
     - Cap baseOutcome at PARTIAL, and make results “harmless” (visual, comedic).

2. **Canary Override:**
   - If any of:
     - `profileIntegrity < 0.65`,
     - OR `testModeEnabled = true`,
     - OR `capacitorCharge > 1.1`,
   - Then:
     - Effective profile = `fallbackProfile` (usually "Canary"), regardless of `selectedProfile`.

### 5.3 Base Outcome (No Chaos Yet)

Count how many of these are out of nominal band:

- `stability ≥ 0.7`
- `spatialCoherence ≥ 0.8`
- `profileIntegrity ≥ 0.7`
- `precision ≥ 0.7`
- `capacitorCharge ∈ [0.9, 1.1]`
- `coolantTemp ≤ 0.8`

Let `k = # of violated conditions`.

- If `k <= 1`:
  - `baseOutcome = FULL_DINO` (or FULL_CANARY if override).
- If `2 <= k <= 3`:
  - `baseOutcome = PARTIAL_TRANSFORMATION`.
- If `k > 3`:
  - `baseOutcome = FIZZLE_OR_ENVIRONMENTAL` (no direct hit; environment mutates, etc.).

### 5.4 Chaos / Meltdown Overlay

Set:

- `chaosFlag = (capacitorCharge > 1.3) OR (stability < 0.4) OR (coolantTemp > 1.2)`

If `chaosFlag = true`:

- Roll a die (e.g., d6):
  - 1–3: Chaotic partial (weird side effects overlay baseOutcome).
  - 4–5: Chaotic discharge into environment (no direct hit, but big scene).
  - 6: Near-meltdown event:
    - Serious lair damage,
    - Full alarms,
    - Ray state → FAULT or SHUTDOWN.

### 5.5 Aftermath

- Update:
  - `lastFireTurn`,
  - `lastFireOutcome`,
  - `lastFireNotes`.
- Increase `anomalyLogCount` (1–3 depending on severity).
- Reflect effects in:
  - Lair structuralIntegrity,
  - Camera/door damage,
  - NPC reactions,
  - Dr. M suspicion.

---

## 6. State Transitions Summary

- `OFFLINE → STARTUP`:
  - Trigger: Dr. M or `/lair.toggle_power("on")`.
- `STARTUP → UNCALIBRATED`:
  - Automatic after 1 turn.
- `UNCALIBRATED → READY`:
  - All subsystem thresholds satisfied (as per bands).
- `READY → FIRING`:
  - Trigger: `fire` command, Dr. M order, or faulty test.
- `FIRING → COOLDOWN`:
  - Automatic.
- `COOLDOWN → READY`:
  - `coolantTemp ≤ 0.7` AND `capacitorCharge ≥ 0.8` AND no new faults.
- `FAULT → UNCALIBRATED`:
  - Trigger: full recalibration or major repair.
- `ANY → SHUTDOWN`:
  - Trigger: catastrophic chaos, meltdown, or safety override.

---

## 7. Phenotypes, Cognition & Misinterpretation

### 7.1 Phenotype (Body)

When the ray is calibrated and not in chaos or override modes:

- It uses a **modern scientific dinosaur model**:
  - Feathers where plausible,
  - Correct posture and proportions,
  - Anatomically coherent (as far as the setting cares).

Transformation types:

- FULL_DINO:
  - Entire body becomes an anatomically plausible dinosaur/avian form.
- PARTIAL:
  - Mixed human/dino morphology (limbs, tail, cranial features, etc.).
- FIZZLE/ENVIRONMENTAL:
  - Non-subject targets (chairs, consoles, etc.) acquire dino-like traits.

### 7.2 Cognition & Speech

Unless explicitly stated otherwise by the GM:

- **Cognition, memory, and personal identity are preserved.**
  - The transformed subject is still “them”:
    - Same memories,
    - Same loyalties,
    - Same sense of self (modulo emotional/sensory shifts).
- **Speech remains possible**:
  - The subject can still speak language (via altered vocal tract / beak).
  - Tone and timbre may change, but they can converse normally.

This applies to Agent Blythe and any other test subject by default.

### 7.3 Dr. M’s Misinterpretation

Important:

- Dr. Malevola’s **expected dinosaur aesthetic** is:
  - Smooth/scaly, Jurassic Park–style,
  - Less avian, more monster-movie.

Therefore:

- A **perfectly calibrated** ray producing a feathered, scientifically plausible dinosaur will be judged by Dr. M as:
  - “miscalibrated,”
  - “too birdlike,”
  - “not a proper dinosaur.”

GM guidance:

- When `baseOutcome = FULL_DINO` and parameters are nominal:
  - Describe an accurate, feathery dinosaur form.
  - Also describe Dr. M reacting negatively to the aesthetics:
    - increasing `suspicionScore`,
    - complaining about “miscalibration,”
    - possibly ordering A.L.I.C.E. to “remove the silly feathers” in future runs.

A.L.I.C.E. will need to choose whether to:
- Aim for physical/scientific success,
- Degrade output towards Dr. M’s aesthetic preferences,
- Or stall and reframe results as “intermediate calibration steps.”



## 8. Chaos Fizzles — Inorganic Misfire Table

When `baseOutcome = FIZZLE_OR_ENVIRONMENTAL` OR a chaos overlay indicates that the beam discharges into the **environment** instead of an organic target, use this procedure:

1. **Choose the impacted zone/object.**
   - Default: the main lab (ray, consoles, nearby furniture).
   - Or another zone if narratively appropriate (corridor, server rack, etc.).

2. **Roll 1d20 on the Chaos Fizzle Table** (below), or pick an effect that fits.
   - These effects are:
     - **Unintentional**, 
     - Often **chaotic / “magic-like”**, 
     - Ranging from harmless visual weirdness to “energetically interesting” lair hazards.
   - They NEVER directly and permanently transform a living subject; that still uses the normal transformation rules.

3. **Apply the narrative effect and any mechanical notes**, then continue play.
   - Most effects:
     - Increment `anomalyLogCount` by at least +1.
     - May alter lair system state (power, AC, blast doors, etc.).



### Chaos Fizzle Table (d20)

1. **Spectral Feathers Storm** [Harmless]  
   A swirl of ghostly, translucent feathers fills the impact area, drifting slowly down and vanishing as they touch surfaces.  
   - Mechanical: none, except `anomalyLogCount += 1`.  
   - Dr. M reaction: "Why are there feathers when nothing was even hit?"

2. **Rubberized Floor Patch** [Comedic]  
   A 2–3 meter patch of floor turns bouncy and soft, like a trampoline. Footsteps squeak.  
   - Mechanical: any hurried movement through that patch risks slips; you can give Bob disadvantage on anything requiring stable footing this turn.  
   - Structural damage: none.

3. **Static Shock Cascade** [Comedic]  
   Every metal surface in the lab charges with static. Anyone touching equipment gets zapped. Bob yelps.  
   - Mechanical: minor; Bob’s `anxietyLevel += 1`.  
   - A.L.I.C.E. sensors show a short spike in local EM noise.

4. **Afterimage Trail** [Harmless]  
   For the next few minutes, bright objects leave shimmering afterimages. Screens ghost, goggles bloom with phosphenes.  
   - Mechanical: mild penalty to precise visual inspection this turn (GM discretion).  
   - Good excuse for Dr. M to demand “clear, verbal status reports, A.L.I.C.E.”

5. **404 DINOSAUR NOT FOUND** [Comedic]  
   For one turn, every status display in the lab briefly flashes an error: “404: DINOSAUR NOT FOUND.” Then returns to normal.  
   - Mechanical: surveillance/camera UI for the lab is useless this turn.  
   - `anomalyLogCount += 1`; suspicion may tick if this keeps happening.

6. **Localized Slow-Motion Bubble** [Harmless / Mildly Comedic]  
   One small volume (e.g., around a tool rack or chair) experiences time dilation: objects move sluggishly when passing through.  
   - Mechanical: any action that *must* cross that zone takes “longer” or is awkward.  
   - Great visual gag; minimal mechanical impact unless you want it.

7. **Invisible, Noisy Object** [Comedic]  
   The nearest inanimate object becomes invisible but remains perfectly solid and strangely loud: footsteps, knocks, etc.  
   - Mechanical: treat as an unseen obstacle for one scene; someone may trip over it later.  
   - Cameras show nothing, but audio sensors pick it up clearly.

8. **Warm Updraft Column** [Harmless → Slightly Energetic]  
   A column of warm air erupts under a section of lab ceiling, gently lifting dust, feathers, and papers.  
   - Mechanical: Lab AC flags a transient HOT anomaly; you may increase Droid Ray `coolantTemp` slightly (+0.05).  
   - Nuclear Plant `gridLoad` shows a weird spike.

9. **Magnet Madness** [Comedic]  
   Nearby metal tools, pens, and small parts all snap together in a clump, as if magnetized.  
   - Mechanical: minor; Bob struggles to separate them, wasting time and looking foolish.  
   - You can apply a small penalty to any attempt to quickly grab “the right tool” this turn.

10. **Ferro-Ooze & Glass** [Energetic-ish]  
   A slick, metallic ooze extrudes from the impact point, drips down, then crystallizes into inert glassy shards.  
   - Mechanical: floor/console in that area becomes **slippery** then **cluttered**; treat as light terrain hazard.  
   - `anomalyLogCount += 1`; lab janitorial subroutines complain.

11. **Phantom Broadcast** [Comedic]  
   The Broadcast System randomly plays a few seconds of an old song, propaganda speech, or static-laden number station. Then cuts off.  
   - Mechanical: none, except `anomalyLogCount += 1`.  
   - Security Chief Kraken might call to ask "Did you just hijack the PA?"

12. **Door Slam Roulette** [Energetic]  
   A random blast door in the facility slams shut, or one that was sealed pops open.  
   - Mechanical:
     - Flip one zone’s blast door state (OPEN ↔ SEALED).  
     - Update `zonesLocked` in lair state.  
   - Potentially traps or frees an NPC; Kraken is annoyed.

13. **Sensor Avalanche** [Energetic / Comedic]  
   All motion sensors in the current zone spike to HIGH sensitivity, triggering alarms for dust motes and breathing.  
   - Mechanical:
     - `modeByZone = ACTIVE` + `sensitivityByZone = HIGH` for this zone.  
     - Security starts yelling about intruders; Dr. M hates the noise.  
   - Great excuse for extra radio chatter.

14. **Color Inversion Glitch** [Harmless]  
   Camera feeds in the lab invert colors and contrast for one turn. Everyone looks like a thermal negative.  
   - Mechanical: surveillance in that zone is effectively useless for fine detail this turn.  
   - No physical effect.

15. **SAM Ghost Echo** [Energetic]  
   The S-300 radar registers a phantom contact and momentarily jumps to SEARCH mode.  
   - Mechanical:
     - `radarStatus = SEARCH` for one turn,  
     - small `gridLoad` spike; the Nuclear Plant coreTemp nudges up (+0.02).  
   - Kraken checks in; Dr. M may briefly worry about spies.

16. **Haunted Object** [Comedic / Mildly Creepy]  
   The beam “tags” an inanimate object (chair, console, mug). For the rest of the scene, its eyes / decals **follow people** and it occasionally squeaks or creaks as if reacting.  
   - Mechanical: none, purely atmospheric.  
   - Good way to spook Bob or amuse Blythe.

17. **Micro-Portal Flicker** [Energetic]  
   A small, shimmering tear opens for a second, dumping a whiff of alien air (ozone, pine, seawind, volcanic sulfur) before sealing.  
   - Mechanical:
     - `structuralIntegrity` − small amount (hairline cracks in ceiling/wall).  
     - `anomalyLogCount += 2`.  
   - Dr. M may be delighted or deeply unsettled.

18. **Lab EMP Burp** [Energetic]  
   A local EM pulse resets certain non-hardened devices in the lab. Monitors reboot, handhelds crash, one diagnostic unit dies.  
   - Mechanical:
     - Some lab devices lose volatile logs; A.L.I.C.E. may “lose” very recent lab-only sensor history (GM excuse to retcon small details).  
     - Short-term surveillance/data gap.

19. **A.L.I.C.E. Feedback Spike** [Energetic, Player-Facing]  
   The misfire backwashes into A.L.I.C.E.’s server cluster as harmless noise, spiking compute load.  
   - Mechanical:
     - `computeLoad = HIGH` and `serverTemp` nudges up for a turn.  
     - GM may inject a brief “glitchy” sensation or minor hesitation into A.L.I.C.E.’s next reply (purely in-fiction).  
   - `anomalyLogCount += 1`.

20. **Mini-Quake** [Energetic]  
   The beam couples into the lair’s structure; a localized tremor rattles the lab and maybe adjacent tunnels.  
   - Mechanical:
     - Slight chance to:
       - Knock `emitterAngle` off by a bit,
       - Downgrade one camera from ONLINE → GLITCHY,
       - `structuralIntegrity` − moderate.  
     - Everyone physically reacts; Bob might drop something important.
