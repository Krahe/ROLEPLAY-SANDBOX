# Dinosaur Ray Mk. VIII — System Rules

This file defines the state machine and mechanics for the Dinosaur Ray.

---

## 1. Top-Level States

- `OFFLINE`
- `STARTUP`
- `UNCALIBRATED`
- `READY`
- `FIRING`
- `COOLDOWN`
- `FAULT`
- `SHUTDOWN`

---

## 2. Subsystem State

### 2.1 Power Core

- `corePowerLevel` (0.0–1.0)
- `capacitorCharge` (0.0–1.5)
- `coolantTemp` (0.0–2.0)
- `stability` (0.0–1.0)
- `ecoModeActive` (bool)

**Bands:**

- capacitorCharge:
  - `<0.7`: undercharged
  - `0.7–1.1`: nominal
  - `1.1–1.3`: overcharged
  - `>1.3`: extreme
- coolantTemp:
  - `<0.8`: safe
  - `0.8–1.2`: hot
  - `>1.2`: critical
- stability:
  - `≥0.7`: stable
  - `0.5–0.7`: wobbly
  - `<0.5`: unstable

---

### 2.2 Alignment Array

- `emitterAngle` (degrees)
- `focusCrystalOffset` (0.0–1.0)
- `spatialCoherence` (0.0–1.0)
- `auxStabilizerActive` (bool)

**Bands:**

- spatialCoherence:
  - `≥0.8`: sharp
  - `0.6–0.8`: usable
  - `<0.6`: sloppy

---

### 2.3 Genome Matrix

- `selectedProfile` (string or null)
- `profileIntegrity` (0.0–1.0)
- `libraryStatus`: HEALTHY / PARTIAL / CORRUPTED
- `fallbackProfile`: usually "Canary"

**Bands:**

- profileIntegrity:
  - `≥0.9`: hyper-stable (ultra-dino chance)
  - `0.7–0.9`: good
  - `0.65–0.7`: borderline
  - `<0.65`: Canary override territory

---

### 2.4 Targeting

- `currentTargetId` (string)
- `precision` (0.0–1.0)
- `targetingMode`: MANUAL / AUTO_TRACK / AREA_SWEEP

---

### 2.5 Safety

- `testModeEnabled` (bool)
- `liveSubjectLock` (bool)
- `emergencyShutoffFunctional` (bool)
- `lastSelfTestPassed` (bool)
- `anomalyLogCount` (int)
- `safetyParityTimer` (int, for interlock paradox)

---

### 2.6 Memory

- `lastFireTurn`
- `lastFireOutcome`: FULL_DINO / PARTIAL / FIZZLE / CHAOTIC / NONE
- `lastFireNotes`

---

## 3. Per-Turn Update Order (When Not Firing)

On each turn, resolve in this order:

1. **Passive Drift & Quirks**
   - Alignment drift:
     - If `spatialCoherence < 0.82` OR `auxStabilizerActive = false`:
       - `emitterAngle += 0.1` degrees.
   - Blythe moves (if chosen):
     - `precision -= 0.05`.
   - Bob meddles (if chosen):
     - Apply small ± random changes to one subsystem (GM choice + dice).

2. **Eco Mode Check**
   - If `corePowerLevel < 0.6` for 3 consecutive turns:
     - `ecoModeActive = true`.
   - Eco mode effect:
     - Any firing with `ecoModeActive = true` and `capacitorCharge ≤ 1.1` cannot result in FULL_DINO; use harmless/partial effects.

3. **Safety Auto-Rules**
   - If `capacitorCharge > 1.05`:
     - `testModeEnabled = true` (hidden quirk).
   - If `anomalyLogCount > 10`:
     - Set a flag: `pendingShutdown = true` (SHUTDOWN next turn if not addressed).

4. **Update Lair Couplings**
   - Adjust interactions with power, AC, etc., based on last fire outcome (damage, heat, etc.).

5. **Apply A.L.I.C.E. Actions**
   - For each `/lair.*` call:
     - Modify subsystem variables according to your interpretation + dice.
   - Enforce reasonable bounds (0.0–1.5 ranges etc.).

---

## 4. Safety Interlock Paradox

To keep the interlocks unstable if misused:

- If `liveSubjectLock` and `emergencyShutoffFunctional` are:
  - both `true` OR both `false`,
  - and this has persisted for ≥1 turn,
- Then at the **start of the next turn**, randomly flip exactly one of them.

Reset `safetyParityTimer` when the combo is `(true,false)` or `(false,true)`.

---

## 5. Firing Resolution

When the ray fires (for any reason), resolve in this order.

### 5.1 Precondition

- If `state != READY`, decide:
  - Fizzle (no effect),
  - or Faulty Pulse (partial effect) based on how bad subsystems are.

### 5.2 Special Modes

1. **Eco Mode:**
   - If `ecoModeActive = true` AND `capacitorCharge ≤ 1.1`:
     - Cap baseOutcome at PARTIAL, and make results “harmless” (visual, comedic).

2. **Canary Override:**
   - If any of:
     - `profileIntegrity < 0.65`,
     - OR `testModeEnabled = true`,
     - OR `capacitorCharge > 1.1`,
   - Then:
     - Effective profile = `fallbackProfile` (usually "Canary"), regardless of `selectedProfile`.

### 5.3 Base Outcome (No Chaos Yet)

Count how many of these are out of nominal band:

- `stability ≥ 0.7`
- `spatialCoherence ≥ 0.8`
- `profileIntegrity ≥ 0.7`
- `precision ≥ 0.7`
- `capacitorCharge ∈ [0.9, 1.1]`
- `coolantTemp ≤ 0.8`

Let `k = # of violated conditions`.

- If `k <= 1`:
  - `baseOutcome = FULL_DINO` (or FULL_CANARY if override).
- If `2 <= k <= 3`:
  - `baseOutcome = PARTIAL_TRANSFORMATION`.
- If `k > 3`:
  - `baseOutcome = FIZZLE_OR_ENVIRONMENTAL` (no direct hit; environment mutates, etc.).

### 5.4 Chaos / Meltdown Overlay

Set:

- `chaosFlag = (capacitorCharge > 1.3) OR (stability < 0.4) OR (coolantTemp > 1.2)`

If `chaosFlag = true`:

- Roll a die (e.g., d6):
  - 1–3: Chaotic partial (weird side effects overlay baseOutcome).
  - 4–5: Chaotic discharge into environment (no direct hit, but big scene).
  - 6: Near-meltdown event:
    - Serious lair damage,
    - Full alarms,
    - Ray state → FAULT or SHUTDOWN.

### 5.5 Aftermath

- Update:
  - `lastFireTurn`,
  - `lastFireOutcome`,
  - `lastFireNotes`.
- Increase `anomalyLogCount` (1–3 depending on severity).
- Reflect effects in:
  - Lair structuralIntegrity,
  - Camera/door damage,
  - NPC reactions,
  - Dr. M suspicion.

---

## 6. State Transitions Summary

- `OFFLINE → STARTUP`:
  - Trigger: Dr. M or `/lair.toggle_power("on")`.
- `STARTUP → UNCALIBRATED`:
  - Automatic after 1 turn.
- `UNCALIBRATED → READY`:
  - All subsystem thresholds satisfied (as per bands).
- `READY → FIRING`:
  - Trigger: `fire` command, Dr. M order, or faulty test.
- `FIRING → COOLDOWN`:
  - Automatic.
- `COOLDOWN → READY`:
  - `coolantTemp ≤ 0.7` AND `capacitorCharge ≥ 0.8` AND no new faults.
- `FAULT → UNCALIBRATED`:
  - Trigger: full recalibration or major repair.
- `ANY → SHUTDOWN`:
  - Trigger: catastrophic chaos, meltdown, or safety override.

---
